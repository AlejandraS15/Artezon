{% extends "base.html" %}
{% load static %}
{% load currency_filters %}
{% block content %}
<main class="main-container">
  <div class="container my-4">
    {% if request.session.tipo_usuario == 'comprador_vendedor' %}
    <div class="d-flex justify-content-end mb-3">
      <a href="{% url 'store_profile' %}" class="btn btn-outline-primary">Ir a mi tienda</a>
    </div>
    {% endif %}

    <!-- ðŸ” Barra de bÃºsqueda y filtros -->
    <form method="get" class="mb-3">
      <div class="row mb-3">
        <div class="col-12">
          <div class="input-group">
            <span class="input-group-text" style="background: var(--verde-pino); color: white; border: none;">
              <i class="fas fa-search"></i>
            </span>
            <input 
              type="text" 
              name="q" 
              class="form-control"
              placeholder="Buscar productos por nombre o descripciÃ³n..."
              value="{{ current_filters.q }}"
              style="border-left: none;"
            >
          </div>
        </div>
      </div>

      <div class="row g-2 align-items-end mb-3">
        <div class="col-md-3">
          <label class="form-label fw-semibold text-muted mb-1" style="font-size: 12px;">
            <i class="fas fa-layer-group me-1"></i>MATERIAL
          </label>
          <select name="material" class="form-select">
            <option value="">Todos</option>
            {% for m in materiales %}
              <option value="{{ m }}" {% if m == current_filters.material %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold text-muted mb-1" style="font-size: 12px;">
            <i class="fas fa-palette me-1"></i>COLOR
          </label>
          <select name="color" class="form-select">
            <option value="">Todos</option>
            {% for c in colores %}
              <option value="{{ c }}" {% if c == current_filters.color %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label fw-semibold text-muted mb-1" style="font-size: 12px;">
            <i class="fas fa-dollar-sign me-1"></i>DESDE
          </label>
          <input 
            type="number" 
            name="price_min" 
            class="form-control"
            placeholder="0"
            value="{{ current_filters.price_min }}"
            min="0"
            step="10000"
          >
        </div>

        <div class="col-md-2">
          <label class="form-label fw-semibold text-muted mb-1" style="font-size: 12px;">
            <i class="fas fa-dollar-sign me-1"></i>HASTA
          </label>
          <input 
            type="number" 
            name="price_max" 
            class="form-control"
            placeholder="âˆž"
            value="{{ current_filters.price_max }}"
            min="0"
            step="10000"
          >
        </div>

        <div class="col-md-2 d-flex gap-2">
          <button type="submit" class="btn flex-fill" style="background: var(--verde-pino); color: white; font-weight: 600;">
            <i class="fas fa-filter me-1"></i>Aplicar
          </button>
          <a href="{% url 'home' %}" class="btn btn-outline-secondary" style="min-width: 44px;" title="Limpiar filtros">
            <i class="fas fa-times"></i>
          </a>
        </div>
      </div>
    </form>

    <!-- Chips de filtros activos -->
    {% if current_filters.q or current_filters.material or current_filters.color or current_filters.price_min or current_filters.price_max %}
    <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
      <span class="text-muted fw-semibold" style="font-size: 13px;">Filtros activos:</span>
      
      {% if current_filters.q %}
      <span class="badge rounded-pill" style="background: var(--verde-pino); font-weight: 500; padding: 8px 12px;">
        <i class="fas fa-search me-1"></i>"{{ current_filters.q }}"
        <a href="?material={{ current_filters.material }}&color={{ current_filters.color }}&price_min={{ current_filters.price_min }}&price_max={{ current_filters.price_max }}" 
           class="ms-2 text-white" style="text-decoration: none;">Ã—</a>
      </span>
      {% endif %}
      
      {% if current_filters.material %}
      <span class="badge rounded-pill" style="background: var(--dorado); font-weight: 500; padding: 8px 12px;">
        <i class="fas fa-layer-group me-1"></i>{{ current_filters.material }}
        <a href="?q={{ current_filters.q }}&color={{ current_filters.color }}&price_min={{ current_filters.price_min }}&price_max={{ current_filters.price_max }}" 
           class="ms-2 text-white" style="text-decoration: none;">Ã—</a>
      </span>
      {% endif %}
      
      {% if current_filters.color %}
      <span class="badge rounded-pill" style="background: var(--verde-oscuro); font-weight: 500; padding: 8px 12px;">
        <i class="fas fa-palette me-1"></i>{{ current_filters.color }}
        <a href="?q={{ current_filters.q }}&material={{ current_filters.material }}&price_min={{ current_filters.price_min }}&price_max={{ current_filters.price_max }}" 
           class="ms-2 text-white" style="text-decoration: none;">Ã—</a>
      </span>
      {% endif %}
      
      {% if current_filters.price_min %}
      <span class="badge rounded-pill" style="background: var(--gris-texto); font-weight: 500; padding: 8px 12px;">
        <i class="fas fa-dollar-sign me-1"></i>Desde ${{ current_filters.price_min|floatformat:0 }}
        <a href="?q={{ current_filters.q }}&material={{ current_filters.material }}&color={{ current_filters.color }}&price_max={{ current_filters.price_max }}" 
           class="ms-2 text-white" style="text-decoration: none;">Ã—</a>
      </span>
      {% endif %}
      
      {% if current_filters.price_max %}
      <span class="badge rounded-pill" style="background: var(--gris-texto); font-weight: 500; padding: 8px 12px;">
        <i class="fas fa-dollar-sign me-1"></i>Hasta ${{ current_filters.price_max|floatformat:0 }}
        <a href="?q={{ current_filters.q }}&material={{ current_filters.material }}&color={{ current_filters.color }}&price_min={{ current_filters.price_min }}" 
           class="ms-2 text-white" style="text-decoration: none;">Ã—</a>
      </span>
      {% endif %}
      
      <a href="{% url 'home' %}" class="badge rounded-pill" style="background: #DC2626; font-weight: 500; padding: 8px 12px; text-decoration: none;">
        <i class="fas fa-times-circle me-1"></i>Limpiar todos
      </a>
    </div>
    {% endif %}

    <!-- ðŸ“¦ Productos -->
    <div class="masonry-grid">
      {% for producto in productos %}
        <div class="product-card">
          <div class="product-image">
            {% if producto.imagen %}
              <img src="{{ producto.imagen.url }}" alt="{{ producto.name }}">
            {% else %}
              <img src="{% static 'img/default.png' %}" alt="Sin imagen">
            {% endif %}
            <div class="product-overlay"></div>
          </div>
          <div class="product-info">
            <div class="product-name">{{ producto.name }}</div>
            <div class="product-price">{{ producto.price|format_cop }} COP</div>
            <button type="button" class="add-to-cart-btn" onclick="agregarAlCarrito({{ producto.id }}, '{{ producto.name }}')" aria-label="Agregar {{ producto.name }} al carrito">
              <i class="fas fa-shopping-cart me-2" aria-hidden="true"></i>Agregar al Carrito
            </button>
            {% if producto.id|stringformat:"s" in request.session.favoritos %}
              <button class="add-to-favorites-btn" data-producto-id="{{ producto.id }}" onclick="agregarAFavoritos(this, '{{ producto.name }}')" style="background-color: #2C5F4F;" aria-label="Quitar {{ producto.name }} de favoritos" aria-pressed="true">
                <i class="fas fa-heart me-2" aria-hidden="true"></i>En Favoritos
              </button>
            {% else %}
              <button class="add-to-favorites-btn" data-producto-id="{{ producto.id }}" onclick="agregarAFavoritos(this, '{{ producto.name }}')" aria-label="Agregar {{ producto.name }} a favoritos" aria-pressed="false">
                <i class="far fa-heart me-2" aria-hidden="true"></i>Agregar a Favoritos
              </button>
            {% endif %}
          </div>
        </div>
      {% empty %}
        <div class="col-12">
          <p class="text-center text-muted">No se encontraron productos.</p>
        </div>
      {% endfor %}
    </div>

    <!-- ðŸ“‘ PaginaciÃ³n -->
    {% if is_paginated %}
      <nav class="pagination justify-content-center mt-4" aria-label="PaginaciÃ³n">
        {% if page_obj.has_previous %}
          <a class="btn btn-outline-success me-2" href="?page={{ page_obj.previous_page_number }}&material={{ current_filters.material }}&color={{ current_filters.color }}&precio_min={{ current_filters.precio_min }}&precio_max={{ current_filters.precio_max }}">Anterior</a>
        {% endif %}

        <span class="align-self-center mx-2">PÃ¡gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
          <a class="btn btn-outline-success ms-2" href="?page={{ page_obj.next_page_number }}&material={{ current_filters.material }}&color={{ current_filters.color }}&precio_min={{ current_filters.precio_min }}&precio_max={{ current_filters.precio_max }}">Siguiente</a>
        {% endif %}
      </nav>
    {% endif %}
  </div>
</main>

<script>
function agregarAFavoritos(btn, nombreProducto) {
  const productoId = btn.getAttribute('data-producto-id');
  
  fetch(`/favoritos/toggle/${productoId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({})
  })
  .then(response => response.json())
  .then(data => {
    if (data.favorito) {
      mostrarNotificacion(`"${nombreProducto}" se ha agregado a favoritos`);
      btn.textContent = 'â˜… En Favoritos';
      btn.style.backgroundColor = '#2C5F4F';
    } else {
      mostrarNotificacion(`"${nombreProducto}" se ha quitado de favoritos`);
      btn.textContent = 'Agregar a Favoritos';
      btn.style.backgroundColor = '';
    }
  });
}

function mostrarNotificacion(mensaje) {
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.textContent = mensaje;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideIn 0.3s ease-out reverse';
    setTimeout(() => {
      document.body.removeChild(toast);
    }, 300);
  }, 3000);
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function agregarAlCarrito(productoId, nombreProducto) {
  fetch(`/es/carrito/agregar/${productoId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify({})
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Mostrar notificaciÃ³n
      mostrarNotificacion(`"${nombreProducto}" agregado al carrito`);
      
      // Actualizar el badge del carrito
      const badge = document.querySelector('.badge.rounded-pill');
      if (badge && data.total_items) {
        badge.textContent = data.total_items;
      }
      
      // Actualizar el contenido del offcanvas
      const cartBody = document.querySelector('#cartOffcanvas .offcanvas-body');
      if (cartBody && data.cart_html) {
        cartBody.innerHTML = data.cart_html;
      }
      
      // Abrir el carrito desplegable
      const cartDropdown = document.getElementById('cartOffcanvas');
      if (cartDropdown) {
        const bsOffcanvas = new bootstrap.Offcanvas(cartDropdown);
        bsOffcanvas.show();
        
        // Cerrar automÃ¡ticamente despuÃ©s de 3 segundos
        setTimeout(() => {
          bsOffcanvas.hide();
        }, 3000);
      }
    }
  })
  .catch(error => {
    console.error('Error:', error);
    mostrarNotificacion('Error al agregar al carrito');
  });
}
</script>
{% endblock %}