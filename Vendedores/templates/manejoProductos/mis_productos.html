{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/mis_productos.css' %}">
<div class="header-misprod">
    <a href="/" class="logo-misprod">Artezon</a>
    <nav class="nav-misprod">
        <a href="/">Inicio</a>
        <a href="/vendedores/mis-productos/" class="active">Mis productos</a>
        <a href="/vendedores/agregar/">Agregar producto</a>
        <a href="/profile/">Perfil</a>
    </nav>
</div>
<div class="hero-misprod">
    <h1>Mis Productos</h1>
    <div class="decorative-line"></div>
    <p>Gestiona tu cat√°logo de artesan√≠as</p>
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-title">Total de productos</div>
            <div class="stat-value">{{ total_productos }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Activos</div>
            <div class="stat-value">{{ productos_activos }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Valor inventario</div>
            <div class="stat-value">${{ valor_inventario|floatformat:0 }}</div>
        </div>
    </div>
    <div class="cta-misprod">
        <a href="/vendedores/agregar/" class="cta-btn"><span style="font-size:22px;">Ôºã</span> Agregar Nuevo Producto</a>
    </div>
</div>
<div class="busqueda-misprod">
    <span class="icono-busqueda"></span>
    <input type="text" id="busquedaInput" placeholder="Buscar producto..." aria-label="Buscar producto">
</div>
<div class="filtros-misprod">
    <button class="chip-filtro active" data-categoria="">Todos</button>
    {% for categoria in categorias %}
        <button class="chip-filtro inactive" data-categoria="{{ categoria }}">{{ categoria }}</button>
    {% endfor %}
</div>
<div id="contadorFiltrados" style="text-align:center; color:var(--gris-texto); margin-bottom:12px; font-size:15px;"></div>
<div class="grid-misprod" id="productosGrid">
    {% for producto in productos %}
        <div class="product-card" data-categoria="{{ producto.category }}" data-nombre="{{ producto.name }}">
            <div class="product-img-wrapper">
                {% if producto.imagen %}
                    <img src="{{ producto.imagen.url }}" alt="Imagen de {{ producto.name }}" class="product-img" loading="lazy">
                {% else %}
                    <div class="product-img" style="background:#F5F3EF;display:flex;align-items:center;justify-content:center;height:100%;font-size:32px;color:#C9A961;">Sin imagen</div>
                {% endif %}
                {% if producto.status == 'activo' %}
                    <span class="product-badge badge-activo">Activo</span>
                {% elif producto.status == 'agotado' %}
                    <span class="product-badge badge-agotado">Agotado</span>
                {% elif producto.status == 'pausado' %}
                    <span class="product-badge badge-pausado">Pausado</span>
                {% endif %}
            </div>
            <div class="product-card-content">
                <div>
                    <div class="product-title" title="{{ producto.name }}">{{ producto.name }}</div>
                    <div class="product-category"><span>üè∑Ô∏è</span> {{ producto.category }}</div>
                    <div class="product-price">${{ producto.price|floatformat:0 }}</div>
                    <div class="product-stock {% if producto.stock > 10 %}stock-verde{% elif producto.stock >= 5 %}stock-amarillo{% else %}stock-rojo{% endif %}">En stock: {{ producto.stock }} unidades</div>
                    <div class="product-desc">{{ producto.description|truncatechars:80 }}</div>
                    <div class="product-meta">
                        <span title="Vistas">üëÅÔ∏è {{ producto.vistas|default:0 }}</span>
                        <span title="Favoritos">‚ù§Ô∏è {{ producto.favoritos|default:0 }}</span>
                        <span title="Publicado">üìÖ {{ producto.fecha_publicacion|timesince }} atr√°s</span>
                    </div>
                </div>
                <div class="product-actions">
                    <a href="{% url 'product_detail' producto.id %}" class="action-btn ver" aria-label="Ver producto"><span></span> Ver</a>
                    <a href="{% url 'editar_producto' producto.id %}" class="action-btn editar" aria-label="Editar producto"><span></span> Editar</a>
                    <button class="action-btn eliminar" aria-label="Eliminar producto" onclick="abrirModalEliminar({{ producto.id }}, '{{ producto.name|escapejs }}', '{% if producto.imagen %}{{ producto.imagen.url }}{% else %}{% endif %}')"><span>üóëÔ∏è</span> Eliminar</button>
                </div>
            </div>
        </div>
    {% empty %}

    {% endfor %}
</div>
<div class="paginacion-misprod">
    {% if is_paginated %}
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="page-btn">&laquo;</a>
        {% endif %}
        {% for num in paginator.page_range %}
            <a href="?page={{ num }}" class="page-btn {% if page_obj.number == num %}active{% endif %}">{{ num }}</a>
        {% endfor %}
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="page-btn">&raquo;</a>
        {% endif %}
    {% endif %}
</div>
<!-- Modal eliminaci√≥n -->
<div id="modalOverlay" class="modal-overlay" style="display:none;">
    <div class="modal-eliminar">
        <div class="modal-icon">‚ö†Ô∏è</div>
        <h3>¬øEliminar producto?</h3>
        <p>Esta acci√≥n no se puede deshacer</p>
        <img id="modalImg" class="modal-img" src="" alt="Imagen producto" style="display:none;">
        <div id="modalNombre" style="font-weight:600;margin-bottom:12px;"></div>
        <form id="formEliminar" method="post" style="margin:0;">
            {% csrf_token %}
            <div class="modal-actions">
                <button type="button" class="btn-cancelar" onclick="cerrarModalEliminar()">Cancelar</button>
                <button type="submit" class="btn-eliminar">Eliminar</button>
            </div>
        </form>
    </div>
</div>
<!-- Toast notifications -->
<div id="toastContainer"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/17.8.3/lazyload.min.js"></script>
<script>
// Filtros y b√∫squeda
const busquedaInput = document.getElementById('busquedaInput');
const productosGrid = document.getElementById('productosGrid');
const chips = document.querySelectorAll('.chip-filtro');
const cards = productosGrid ? Array.from(productosGrid.children) : [];
const contadorFiltrados = document.getElementById('contadorFiltrados');
let categoriaActiva = '';
function filtrarProductos() {
    const texto = busquedaInput.value.toLowerCase();
    let count = 0;
    cards.forEach(card => {
        const nombre = card.getAttribute('data-nombre').toLowerCase();
        const categoria = card.getAttribute('data-categoria');
        const matchNombre = nombre.includes(texto);
        const matchCategoria = !categoriaActiva || categoria === categoriaActiva;
        if (matchNombre && matchCategoria) {
            card.style.display = '';
            count++;
        } else {
            card.style.display = 'none';
        }
    });
    contadorFiltrados.textContent = count + ' producto(s) mostrado(s)';
}
if (busquedaInput) {
    busquedaInput.addEventListener('input', filtrarProductos);
}
chips.forEach(chip => {
    chip.addEventListener('click', function() {
        chips.forEach(c => c.classList.remove('active'));
        this.classList.add('active');
        categoriaActiva = this.getAttribute('data-categoria');
        filtrarProductos();
    });
});
filtrarProductos();
// Modal eliminaci√≥n
let productoAEliminar = null;
function abrirModalEliminar(id, nombre, imgUrl) {
    productoAEliminar = id;
    document.getElementById('modalOverlay').style.display = 'flex';
    document.getElementById('modalNombre').textContent = nombre;
    const img = document.getElementById('modalImg');
    if (imgUrl) {
        img.src = imgUrl;
        img.style.display = 'block';
    } else {
        img.style.display = 'none';
    }
    const form = document.getElementById('formEliminar');
    form.action = `/vendedores/eliminar/${id}/`;
}
function cerrarModalEliminar() {
    document.getElementById('modalOverlay').style.display = 'none';
    productoAEliminar = null;
}
// Toast notifications
function showToast(type, message) {
    const icons = {success:'‚úîÔ∏è', error:'‚ùå', warning:'‚ö†Ô∏è', info:'‚ÑπÔ∏è'};
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.innerHTML = `<span class="toast-icon">${icons[type]||''}</span> <span>${message}</span> <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>`;
    document.getElementById('toastContainer').appendChild(toast);
    setTimeout(() => { toast.remove(); }, 3000);
}
// Animaci√≥n stagger
cards.forEach((card, i) => {
    card.style.animationDelay = (i * 0.1) + 's';
});
// Lazy loading
if (window.LazyLoad) { new LazyLoad({ elements_selector: '.product-img' }); }
</script>
{% endblock %}
